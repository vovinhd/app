<script lang="ts">
	import { currentUser, pb } from '$lib/Services/PocketbaseWrapper';
	import { onDestroy, onMount } from 'svelte';

	export let completions = 0;
	export let streak = 0;

	let unsubscribe: Function;

	const update = ({ action, record }: any) => {
		console.log('updated!', action);
		console.log('updated!', record);
	};

	onMount(async () => {
		if (!$currentUser) {
			return;
		}
		var _resParticipations = await pb.collection('participations_count').getOne($currentUser.id);
		var _resStreak = await pb.collection('streak_count').getOne($currentUser.id);
		completions = _resParticipations.count;
		streak = _resStreak.length;
		unsubscribe = await pb.collection('participations_count').subscribe($currentUser.id, update);
	
	});

	onDestroy(async () => {
		if (unsubscribe != undefined) {
			console.log('closing rtc!');
			unsubscribe();
		}
	});
</script>

{#if currentUser}
	<div
		class="sc shadow relative overflow-clip flex flex-row rounded-full border border-neutral-300 bg-neutral-50 px-2 py-1 text-lg w-40"
	>
		<div class="flex flex-row justify-between items-center text-accent-500 ml-2 mr-4 gap-0 z-20">
			<svg
				xmlns="http://www.w3.org/2000/svg"
				width="26"
				height="24"
				viewBox="0 0 29 29"
				fill="none"
			>
				<path
					fill-rule="evenodd"
					clip-rule="evenodd"
					d="M17.0474 2.94858C17.4494 3.05533 17.7862 3.32954 17.9721 3.70154C18.6733 5.10387 19.1966 5.95498 19.7231 6.64505C20.256 7.34356 20.8197 7.91539 21.6772 8.7729C23.6589 10.7545 24.6501 13.3547 24.6501 15.95C24.6501 18.5454 23.6589 21.1455 21.6772 23.1272C17.7134 27.091 11.2868 27.091 7.32296 23.1272C5.34134 21.1455 4.3501 18.5454 4.3501 15.95C4.35009 13.3547 5.34133 10.7545 7.32296 8.7729C7.73766 8.3582 8.36133 8.23414 8.90316 8.45858C9.44499 8.68301 9.79827 9.21173 9.79827 9.7982C9.79827 11.4219 9.89966 12.6592 10.3746 13.646C10.6357 14.1886 11.0431 14.7192 11.7452 15.1926C11.9128 13.6545 12.22 11.7805 12.635 10.0018C12.9618 8.60133 13.3682 7.2032 13.8519 6.0373C14.0939 5.45415 14.3675 4.89888 14.6782 4.41946C14.9807 3.9528 15.3693 3.47793 15.8709 3.14353C16.217 2.91283 16.6454 2.84183 17.0474 2.94858ZM17.576 21.9259C15.8772 23.6247 13.123 23.6247 11.4242 21.9259C10.5748 21.0765 10.1501 19.9633 10.1501 18.85C10.1501 18.85 11.4242 19.575 13.7752 19.575C13.7752 18.125 14.5002 13.775 15.5877 13.05C16.3127 14.5 16.7266 14.9247 17.576 15.7741C18.4254 16.6235 18.8501 17.7367 18.8501 18.85C18.8501 19.9633 18.4254 21.0765 17.576 21.9259Z"
					fill="currentcolor"
				/>
			</svg>
			<span class="text-neutral-900">{streak}</span>
		</div>
		<div class="flex flex-row  items-center justify-end text-white ml-6 mr-3 gap-0.5 bg-primary-500 z-20">
			<svg
				width="26"
				height="24"
				viewBox="0 0 26 25"
				fill="none"
				xmlns="http://www.w3.org/2000/svg"
			>
				<path
					d="M11.4531 6.14062C9.48438 6.46875 7.70312 7.35938 6.34375 8.67188L1.09375 1.21875C0.765625 0.703125 1.14062 0 1.75 0H7.375C7.60938 0 7.89062 0.140625 7.98438 0.375L11.4531 6.14062ZM13 7.5C17.5469 7.5 21.25 11.2031 21.25 15.75C21.25 20.3438 17.5469 24 13 24C8.40625 24 4.75 20.3438 4.75 15.75C4.75 11.2031 8.40625 7.5 13 7.5ZM17.3125 14.9062C17.6406 14.5781 17.4531 14.0156 17.0312 13.9688L14.5469 13.5938L13.4688 11.3906C13.375 11.2031 13.1875 11.1094 12.9531 11.1094C12.7656 11.1094 12.5781 11.2031 12.4844 11.3906L11.4062 13.5938L8.92188 13.9688C8.5 14.0156 8.3125 14.5781 8.64062 14.9062L10.4219 16.6406L10 19.0781C9.90625 19.5 10.375 19.8281 10.7969 19.6406L12.9531 18.4688L15.1562 19.6406C15.5781 19.875 16.0469 19.5 15.9531 19.0781L15.5312 16.6406L17.3125 14.9062ZM24.2031 0C24.8125 0 25.1875 0.703125 24.8594 1.17188L19.6094 8.625C18.25 7.3125 16.4688 6.42188 14.5 6.09375L17.9219 0.375C18.0625 0.140625 18.3438 0 18.5781 0H24.2031Z"
					fill="currentcolor"
				/>
			</svg>
			<span>{completions}</span>
		</div>
	</div>
{:else}
	<!-- hide the streak counter if it somehow got rendered without a signed in user -->
{/if}

<style lang="scss">
	.sc {
		--diag: 2.5%;
	}
	.sc::after {
		@apply absolute inset-0 bg-primary-500 z-10;
		content: '';
		clip-path: polygon(
			calc(50% - var(--diag)) 0%,
			120% 0%,
			120% 100%,
			calc(50% + var(--diag)) 100%
		);
	}
</style>
